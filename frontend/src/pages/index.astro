---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Betting Validation Engine | High Concurrency">
	<section class="status-panel">
        <div class="status-card" id="api-status">
            <div class="status-dot"></div>
            <span class="status-text">Checking System Status...</span>
        </div>
    </section>

    <section class="main-content">
        <div class="form-card">
            <h2>Live Bet Validation</h2>
            <p>Engine focused on sub-millisecond validation for high-volume live events.</p>
            
            <form id="bet-form">
                <div class="input-group">
                    <label for="user_id">User Identifier (UUID)</label>
                    <input
                        type="text"
                        id="user_id"
                        name="user_id"
                        placeholder="e.g. 550e8400-e29b-41d4-a716-446655440000"
                        required
                    />
                    <small style="color: var(--text-dim); cursor: pointer;" id="gen-id">Generate Random ID</small>
                </div>

                <div class="row">
                    <div class="input-group">
                        <label for="match_id">Live Match ID</label>
                        <input
                            type="text"
                            id="match_id"
                            name="match_id"
                            value="123e4567-e89b-12d3-a456-426614174000"
                            required
                        />
                    </div>
                    <div class="input-group">
                        <label for="odds">Current Odds</label>
                        <input
                            type="number"
                            id="odds"
                            name="odds"
                            value="1.85"
                            step="0.01"
                            required
                        />
                    </div>
                </div>

                <div class="input-group">
                    <label for="amount">Wager Amount ($)</label>
                    <input
                        type="number"
                        id="amount"
                        name="amount"
                        placeholder="10.00"
                        step="0.01"
                        required
                    />
                </div>

                <button type="submit" id="submit-btn" class="btn-primary">
                    <span class="btn-text">Validate & Process Bet</span>
                    <div class="loader-small" hidden></div>
                </button>
                <div id="form-message" class="message"></div>
            </form>
        </div>

        <div class="info-card">
            <h2>Performance Metrics</h2>
            <ul class="features-list">
                <li><strong>Target throughput:</strong> 10k+ req/sec</li>
                <li><strong>Mean Latency:</strong> &lt;10ms</li>
                <li><strong>Backend:</strong> Rust (Actix + SQLx)</li>
                <li><strong>Cache Layer:</strong> Redis (Pub/Sub ready)</li>
            </ul>
            
            <div style="margin-top: 2rem;">
                <h3>Real-time Log</h3>
                <ul class="features-list" id="activity-log" style="font-size: 0.8rem; opacity: 0.8;">
                    <li>Engine standby. Waiting for transaction...</li>
                </ul>
            </div>

            <div class="cloud-compatibility" style="margin-top: 2rem;">
                <span class="badge">k6 stress tested</span>
                <span class="badge">low-latency</span>
                <span class="badge">horizontal focus</span>
            </div>
        </div>
    </section>
</Layout>

<script>
    import { v4 as uuidv4 } from 'uuid';

    // Constants
    const API_BASE = "http://localhost:8000";

    // Elements
    const statusDot = document.querySelector(".status-dot")!;
    const statusText = document.querySelector(".status-text")!;
    const form = document.getElementById("bet-form") as HTMLFormElement;
    const submitBtn = document.getElementById("submit-btn") as HTMLButtonElement;
    const loader = submitBtn.querySelector(".loader-small") as HTMLElement;
    const btnText = submitBtn.querySelector(".btn-text") as HTMLElement;
    const message = document.getElementById("form-message")!;
    const activityLog = document.getElementById("activity-log")!;
    const userIdInput = document.getElementById("user_id") as HTMLInputElement;
    const genIdBtn = document.getElementById("gen-id")!;

    // ID Generation
    function generateId() {
        userIdInput.value = window.crypto.randomUUID();
    }
    genIdBtn.addEventListener('click', generateId);
    
    // Auto-fill on start if empty
    if (!userIdInput.value) generateId();

    // Health Check
    async function checkHealth() {
        try {
            const response = await fetch(`${API_BASE}/health_check`);
            if (response.ok) {
                statusDot.classList.add("online");
                statusText.textContent = "Engine Online | High Priority Mode";
            } else {
                throw new Error();
            }
        } catch (error) {
            statusDot.classList.remove("online");
            statusText.textContent = "Engine Offline";
        }
    }
    checkHealth();
    setInterval(checkHealth, 30000);

    // Bet Submission
    form.addEventListener("submit", async (e) => {
        e.preventDefault();
        message.textContent = "";
        btnText.style.display = "none";
        loader.hidden = false;
        submitBtn.disabled = true;

        const payload = {
            user_id: userIdInput.value,
            match_id: (document.getElementById("match_id") as HTMLInputElement).value,
            amount: parseFloat((document.getElementById("amount") as HTMLInputElement).value),
            odds: parseFloat((document.getElementById("odds") as HTMLInputElement).value)
        };

        const startTime = performance.now();

        try {
            const response = await fetch(`${API_BASE}/bets`, {
                method: "POST",
                body: JSON.stringify(payload),
                headers: {
                    "Content-Type": "application/json",
                },
            });

            const endTime = performance.now();
            const latency = (endTime - startTime).toFixed(2);

            if (response.ok) {
                message.textContent = `Validated in ${latency}ms!`;
                message.className = "message success";
                
                const li = document.createElement('li');
                li.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: Validated ($${payload.amount}) - ${latency}ms`;
                activityLog.prepend(li);
                if(activityLog.children.length > 8) activityLog.lastElementChild?.remove();
            } else {
                message.textContent = `Rejected by engine.`;
                message.className = "message error";
            }
        } catch (error) {
            message.textContent = "Connection Error";
            message.className = "message error";
        } finally {
            btnText.style.display = "inline-block";
            loader.hidden = true;
            submitBtn.disabled = false;
        }
    });
</script>
